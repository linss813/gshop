<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.linss.gshop.mapper.ReviewMapper">
    <resultMap id="ReviewResultMap" type="com.linss.gshop.entity.Review">
        <id property="reviewId" column="review_id"/>
        <result property="rating" column="rating"/>
        <result property="comment" column="comment"/>
        <result property="status" column="status"/>
        <result property="createdAt" column="created_at"/>

        <result property="gid" column="gid"/>
        <result property="title" column="title"/>
        <result property="uid" column="uid"/>
        <result property="username" column="username"/>



    </resultMap>

    <select id="getAllReviews" resultType="com.linss.gshop.entity.Review">
        SELECT
        r.review_id, r.uid, r.gid, r.rating, r.comment, r.created_at, r.status,
        u.uid, u.username,
        g.gid, g.title
        FROM review r
        LEFT JOIN user u ON r.uid = u.uid
        LEFT JOIN goods g ON r.gid = g.gid
        ORDER BY r.created_at DESC
    </select>

    <!-- 新增按商品ID查询评论的SQL -->
    <select id="getReviewsByGoodsId" resultMap="ReviewResultMap">
        SELECT
        r.review_id, r.uid, r.gid, r.rating, r.comment, r.created_at, r.status,
        u.uid, u.username,
        g.gid, g.title
        FROM review r
        LEFT JOIN user u ON r.uid = u.uid
        LEFT JOIN goods g ON r.gid = g.gid
        WHERE r.gid = #{gid}
        ORDER BY r.created_at DESC
    </select>

    <select id="getReviewsByGid" resultType="com.linss.gshop.entity.Review">
        SELECT * FROM review WHERE gid = #{gid}
    </select>

    <!-- 新增按评论ID查询评论的SQL -->
    <select id="getReviewById" resultMap="ReviewResultMap">
        SELECT
        r.review_id, r.uid, r.gid, r.rating, r.comment, r.created_at, r.status,
        u.uid, u.username,
        g.gid, g.title
        FROM review r
        LEFT JOIN user u ON r.uid = u.uid
        LEFT JOIN goods g ON r.gid = g.gid
        WHERE review_id = #{reviewId}
        ORDER BY r.created_at DESC
    </select>

    <!-- 新增插入评论的SQL -->
    <insert id="insertReview" parameterType="com.linss.gshop.entity.Review">
        INSERT INTO review (uid, gid, rating, comment, created_at)
        VALUES (#{uid}, #{gid}, #{rating}, #{comment}, NOW())
    </insert>

    <!-- 新增更新评论的SQL -->
    <update id="updateReview">
        UPDATE review
        SET status = #{status}
        WHERE review_id = #{reviewId}
    </update>

    <!-- 新增删除评论的SQL -->
    <delete id="deleteReview">
        DELETE FROM review WHERE review_id = #{reviewId}
    </delete>

    <!-- 新增统计评论数量的SQL -->
    <select id="countReviews" resultType="int">
        SELECT COUNT(*) FROM review
    </select>

    <!-- 新增批量通过审核的 SQL -->
    <update id="batchApprove">
        UPDATE review
        SET status = 1
        WHERE review_id IN
        <foreach collection="reviewIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 新增批量撤销审核的 SQL -->
    <update id="batchReject">
        UPDATE review
        SET status = 0
        WHERE review_id IN
        <foreach collection="reviewIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 修改批量删除的 SQL，支持传入多个 reviewId -->
    <delete id="deleteReviews">
        DELETE FROM review
        WHERE review_id IN
        <foreach collection="reviewIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

    <!-- 新增通用的更新评论状态 SQL -->
    <update id="updateReviewStatus">
        UPDATE review
        SET status = #{status}
        WHERE review_id IN
        <foreach collection="reviewIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <!-- 新增模糊搜索评论内容的SQL -->
    <select id="searchReviewsByContent" resultMap="ReviewResultMap">
        SELECT
        r.review_id, r.uid, r.gid, r.rating, r.comment, r.created_at, r.status,
        u.uid, u.username,
        g.gid, g.title
        FROM review r
        LEFT JOIN user u ON r.uid = u.uid
        LEFT JOIN goods g ON r.gid = g.gid
        WHERE r.comment LIKE CONCAT('%', #{content}, '%')
        ORDER BY r.created_at DESC
    </select>
    <select id="searchReviews" resultMap="ReviewResultMap">
        SELECT
        r.review_id, r.uid, r.gid, r.rating, r.comment, r.created_at, r.status,
        u.uid, u.username,
        g.gid, g.title
        FROM review r
        LEFT JOIN user u ON r.uid = u.uid
        LEFT JOIN goods g ON r.gid = g.gid
        WHERE
        <if test="gid != null">
            r.gid = #{gid}
        </if>
        <if test="content != null and content.trim() != ''">
            AND r.comment LIKE CONCAT('%', #{content}, '%')
        </if>
        ORDER BY r.created_at DESC
    </select>

</mapper>
